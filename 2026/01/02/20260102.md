

```sql
CREATE TABLE IF NOT EXISTS portpolio(
    date TEXT,
    ticker TEXT,
    name TEXT,
    amount INTEGER,
    price TEXT,
    usd_per_krw NUMBER,
    account TEXT,
    type TEXT
);

.mode csv
.import --skip 1 /home/widehyo/not_shared/asset/portpolio.csv portpolio
.header on
select * from portpolio;
```

```awk
BEGIN {
  header = "CREATE TABLE IF NOT EXISTS cash_flow("
  tail = ");"
}

{
  gsub(")", "", $0)
  gsub(/\(/, "_", $0)
       print $0
  split($0, arr, ",")
  for (i = 1; i <= length(arr); i++) {
    col_arr[i] = sprintf("  %s TEXT,", arr[i])
  }
}

END {
  print header
  for (idx in col_arr) {
    print col_arr[idx]
  }
  print tail
}


```

```sql

select price, substr(price, instr(price, ':') + 1) from portpolio;

select
    date,
    ticker,
    name,
    price,
    currency,
    usd_per_krw,
    account,
    type,
    sum(amount) || ' ' || currency as value
from
  portpolio
group by
    date,
    ticker,
    name,
    price,
    currency,
    usd_per_krw,
    account,
    type
;


date,ticker,name,price,currency,usd_per_krw,account,type,value
2025-12-31,"","삼성신종종류형MMF제4호-CP",1,KRW,1444.76,"삼성증권 연금저축","연금저축","4697 KRW"
2025-12-31,"","자동운용상품(고유계정대)",1,KRW,1444.76,"NH IRP",IRP,"2009598 KRW"
2025-12-31,"","현금성자산",1,KRW,1444.76,"IBK 퇴직연금 DC","퇴직연금","6813715 KRW"
2025-12-31,379810,"KODEX 미국나스닥100",24450,KRW,1444.76,"IBK 퇴직연금 DC","퇴직연금","349 KRW"
2025-12-31,379810,"KODEX 미국나스닥100",24450,KRW,1444.76,"NH IRP",IRP,"213 KRW"
2025-12-31,379810,"KODEX 미국나스닥100",24450,KRW,1444.76,"삼성증권 연금저축","연금저축","635 KRW"
2025-12-31,KRW,"원",1,KRW,1444.76,IBK,"일반계좌","978300 KRW"
2025-12-31,KRW,"원",1,KRW,1444.76,NH,"일반계좌","1597068 KRW"
2025-12-31,QLD,"프로셰어즈 QQQ 2배 ETF",71.61,USD,1444.76,"NH CMA","직투계좌","164 USD"
2025-12-31,SGOV,"아이셰어즈 0-3개월 미국 국책 ETF",100.37,USD,1444.76,"NH CMA","직투계좌","90 USD"
2025-12-31,TQQQ,"프로셰어즈 QQQ 3배 ETF",54.10,USD,1444.76,"NH CMA","직투계좌","34 USD"
2025-12-31,USD,"달러",1,USD,1444.76,"NH CMA","직투계좌","35080 USD"
sqlite> 
```


```py
import sqlite3
from pathlib import Path

finance_db_path = Path('~/finance.db').expanduser()

with sqlite3.connect(finance_db_path) as finance_conn:
    cur = finance_conn.cursor()
    query = 'select * from portpolio'
    for row in cur.execute(query):
        print(row)

```

datetime.fromisoformat(row[0])



```py
import sqlite3
from pathlib import Path
from datetime import datetime

def parse_portpolio(row):
    date, ticker, name, amount, price, currency, usd_per_krw, account, type_ = row
    date = datetime.fromisoformat(date)
    price = float(price)
    value = amount * price
    return date, ticker, name, amount, price, currency, usd_per_krw, account, type_, value


finance_db_path = Path('~/finance.db').expanduser()

with sqlite3.connect(finance_db_path) as finance_conn:
    cur = finance_conn.cursor()
    query = 'select * from portpolio'
    # currency, name, type, account, value
    for row in cur.execute(query):
        print(parse_portpolio(row))
```



```py
import sqlite3
from pathlib import Path
from datetime import datetime
import plotly.graph_objects as go

def parse_portpolio(row):
    date, ticker, name, amount, price, currency, usd_per_krw, account, type_ = row
    date = datetime.fromisoformat(date)
    price = float(price)
    value = amount * price
    if currency == "USD":
        value = value * usd_per_krw
    type_dict = {}
    type_dict["연금저축"] = "연금"
    type_dict["IRP"] = "연금"
    type_dict["퇴직연금"] = "연금"
    type_dict["일반계좌"] = "입출금계좌"
    type_dict["직투계좌"] = "직투계좌"
    type_ = type_dict[type_]

    return {
        "currency": currency,
        "name": name,
        "type": type_,
        "account": account,
        "value": value
    }

finance_db_path = Path('~/finance.db').expanduser()

rows = []
with sqlite3.connect(finance_db_path) as conn:
    cur = conn.cursor()
    for row in cur.execute("select * from portpolio"):
        rows.append(parse_portpolio(row))

# 모든 노드 수집
nodes = set()

for r in rows:
    nodes.add(f"CUR:{r['currency']}")
    nodes.add(f"NAME:{r['name']}")
    nodes.add(f"TYPE:{r['type']}")
    nodes.add(f"ACC:{r['account']}")

node_list = list(nodes)
node_index = {n: i for i, n in enumerate(node_list)}

from collections import defaultdict

links = defaultdict(float)

for r in rows:
    v = r["value"]

    links[(f"TYPE:{r['type']}", f"ACC:{r['account']}")] += v
    links[(f"ACC:{r['account']}", f"NAME:{r['name']}")] += v
    links[(f"NAME:{r['name']}", f"CUR:{r['currency']}")] += v

source = []
target = []
value = []

for (s, t), v in links.items():
    source.append(node_index[s])
    target.append(node_index[t])
    value.append(v)

fig = go.Figure(go.Sankey(
    node=dict(
        pad=15,
        thickness=15,
        label=[n.replace("TYPE:", "")
                .replace("ACC:", "")
                .replace("NAME:", "")
                .replace("CUR:", "")
               for n in node_list],
    ),
    link=dict(
        source=source,
        target=target,
        value=value,
    )
))

fig.update_layout(
    title_text="Portfolio Value Flow (Type → Account → Name → Currency)",
    font=dict(family="Noto Sans KR", size=12)
)

fig.show()
```

```py
import sqlite3
from pathlib import Path
from datetime import datetime

import plotly.express as px
import pandas as pd

def parse_portpolio(row):
    date, ticker, name, amount, price, currency, usd_per_krw, account, type_ = row
    date = datetime.fromisoformat(date)
    price = float(price)
    value = amount * price
    if currency == "USD":
        value = value * usd_per_krw
    type_dict = {}
    type_dict["연금저축"] = "연금"
    type_dict["IRP"] = "연금"
    type_dict["퇴직연금"] = "연금"
    type_dict["일반계좌"] = "입출금계좌"
    type_dict["직투계좌"] = "직투계좌"
    type_ = type_dict[type_]

    return {
        "currency": currency,
        "name": name,
        "type": type_,
        "account": account,
        "value": value
    }

def draw_treemap(rows, depth1_key, title):
    df = pd.DataFrame(rows)

    fig = px.treemap(
        df,
        path=[depth1_key, "name"],
        values="value",
        title=depth1_key
    )

    fig.update_layout(
        font=dict(
            family="Noto Sans KR",
            size=12
        )
    )

    fig.show()

finance_db_path = Path('~/finance.db').expanduser()

rows = []
with sqlite3.connect(finance_db_path) as conn:
    cur = conn.cursor()
    for row in cur.execute("select * from portpolio"):
        rows.append(parse_portpolio(row))


# draw_treemap(
#     rows,
#     depth1_key="currency",
#     title="통화별 자산 구성 (Currency → Name)"
# )


# draw_treemap(
#     rows,
#     depth1_key="type",
#     title="계좌유형별 자산 구성 (Type → Name)"
# )


draw_treemap(
    rows,
    depth1_key="account",
    title="계좌별 자산 구성 (Account → Name)"
)
```
